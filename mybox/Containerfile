ARG BASE_IMAGE=quay.io/fedora/fedora-kinoite:43
FROM ${BASE_IMAGE}

# =============================================================================
# Layer 1: DNF Configuration + Repositories + System Update
# =============================================================================
COPY files/dnf.conf /tmp/dnf-extra.conf
COPY files/1password.repo /etc/yum.repos.d/1password.repo

RUN <<EORUN
    set -euxo pipefail

    # DNF configuration
    cat /tmp/dnf-extra.conf >> /etc/dnf/dnf.conf
    rm /tmp/dnf-extra.conf

    # RPM Fusion (needed for NVIDIA drivers)
    source /etc/os-release
    dnf install -y \
        https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$VERSION_ID.noarch.rpm \
        https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$VERSION_ID.noarch.rpm

    # Third-party repositories
    dnf config-manager addrepo --from-repofile=https://cli.github.com/packages/rpm/gh-cli.repo
    dnf config-manager addrepo --from-repofile=https://download.docker.com/linux/fedora/docker-ce.repo
    dnf config-manager addrepo --from-repofile=https://pkgs.tailscale.com/stable/fedora/tailscale.repo

    # 1Password CLI repository
    curl -fsSL https://downloads.1password.com/linux/keys/1password.asc -o /etc/pki/rpm-gpg/RPM-GPG-KEY-1password
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-1password

    # Copr repositories
    dnf copr enable -y @ai-ml/nvidia-container-toolkit
    dnf copr enable -y lizardbyte/beta
    dnf copr enable -y claaj/typst
    dnf copr enable -y luminoso/k9s

    # System update
    dnf update -y
EORUN

# =============================================================================
# Layer 2: Package Installation + NVIDIA Driver Build
# =============================================================================
RUN <<EORUN
    set -euxo pipefail

    # Get kernel version from the image (not the build host)
    KERNEL_UNAME=$(rpm -qa kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}')

    # Kernel development packages (needed for NVIDIA driver build)
    dnf install -y \
        kernel-devel-$KERNEL_UNAME \
        kernel-devel-matched-$KERNEL_UNAME

    # NVIDIA driver (skip scriptlets - they fail as root, we run akmods manually)
    dnf install -y --setopt=tsflags=noscripts akmod-nvidia

    # Build NVIDIA kernel module
    akmods --force --kernels $KERNEL_UNAME
    depmod $KERNEL_UNAME

    # All other packages
    dnf install -y \
        1password-cli \
        nvidia-container-toolkit \
        \
        `# Development tools` \
        cmake \
        emacs \
        fzf \
        gh \
        go-task \
        just \
        libtool \
        moreutils \
        python-devel \
        python-virtualenvwrapper \
        ripgrep \
        sqlite \
        strace \
        typst \
        uv \
        yq \
        zsh \
        \
        `# Virtualization` \
        libvirt \
        libvirt-daemon-kvm \
        qemu-img \
        qemu-kvm \
        qemu-system-$(uname -m) \
        qemu-ui-gtk \
        qemu-user-binfmt \
        qemu-user-static \
        quickemu \
        virt-install \
        virt-manager \
        \
        `# Kubernetes / containers` \
        docker-buildx-plugin \
        docker-ce \
        k9s \
        \
        `# System administration` \
        age \
        apcupsd \
        chezmoi \
        cockpit \
        cockpit-machines \
        cockpit-networkmanager \
        cockpit-podman \
        cockpit-storaged \
        erofs-utils \
        etckeeper \
        nc \
        nfs-utils \
        shairport-sync \
        tailscale \
        tmux \
        \
        `# Desktop applications` \
        chromium \
        thunderbird \
        qt6-qttools \
        Sunshine \
        \
        `# Kerberos / LDAP` \
        krb5-devel \
        krb5-workstation \
        openldap-clients \
        \
        `# Document processing` \
        pandoc
EORUN

# =============================================================================
# Layer 3: Custom Installations (1Password GUI + Cursor)
# =============================================================================
COPY install-cursor.sh /tmp/

RUN <<EORUN
    set -euxo pipefail

    # 1Password GUI
    # We use the tarball instead of the RPM because 1Password does not currently
    # distribute ARM (aarch64) RPMs - only the tarball supports both architectures.
    # Additionally, /opt doesn't exist before boot on atomic systems, so we install
    # to /usr/lib/1Password and create symlinks.
    # See: https://github.com/fedora-sysexts/community/blob/145f8b218e10fffc8cdb885dda1db9ebf06bf4e1/1password-gui/Containerfile
    curl -fL "https://downloads.1password.com/linux/tar/stable/$(uname -m)/1password-latest.tar.gz" -o /tmp/1password.tar.gz
    mv /opt{,.bak}
    mkdir -p /opt/1Password
    tar -xzf /tmp/1password.tar.gz -C /opt/1Password --strip-components=1
    sh /opt/1Password/after-install.sh
    mv /opt/1Password /usr/lib/1Password
    ln -sf /usr/lib/1Password/1password /usr/bin/1password
    ln -sf /usr/lib/1Password/1Password-BrowserSupport /usr/bin/1Password-BrowserSupport
    ln -sf /usr/lib/1Password/1Password-Crash-Handler /usr/bin/1Password-Crash-Handler
    chmod 4755 /usr/lib/1Password/chrome-sandbox
    sed -i 's|^Exec=/opt/1Password|Exec=/usr/bin|g' /usr/share/applications/1password.desktop
    rm -rf /opt
    mv /opt{.bak,}
    1password --version

    # Cursor IDE
    bash /tmp/install-cursor.sh

    # Cleanup
    rm -rf /var/cache/* /tmp/*
EORUN

# =============================================================================
# Layer 4: System Configuration
# =============================================================================
COPY files/00-keyboard.conf /etc/X11/xorg.conf.d/00-keyboard.conf
COPY files/99-udp-buffers.conf /etc/sysctl.d/99-udp-buffers.conf
COPY files/apcupsd.conf /etc/apcupsd/apcupsd.conf

RUN <<EORUN
    set -euxo pipefail

    # TODO: Remove once Kinoite images include the fix from:
    # https://pagure.io/workstation-ostree-config/c/5b4bba7d2555006ea116f6f68d744a32489e1ee5
    # The upstream config references gnome-remote-desktop user which doesn't exist on Kinoite
    cat > /usr/lib/tmpfiles.d/90-atomic-desktops-ownership-fixes.conf <<'EOF'
Z /var/lib/passim - passim passim
Z /var/log/passim - passim passim
Z /etc/colord/    - colord colord
EOF

    # Dvorak keyboard layout for console
    echo 'KEYMAP=dvorak' > /etc/vconsole.conf

    # Locale
    echo 'LANG=en_US.UTF-8' > /etc/locale.conf

    # Timezone
    ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime

    # Enable services
    systemctl enable cockpit.socket
    systemctl enable apcupsd
    systemctl enable shairport-sync
EORUN
