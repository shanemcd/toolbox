---
- name: Ensure chezmoi config directory exists
  ansible.builtin.file:
    path: "{{ dotfiles_chezmoi_config_dir }}"
    state: directory
    mode: '0700'

- name: Check if chezmoi age key already exists
  ansible.builtin.stat:
    path: "{{ dotfiles_chezmoi_key_path }}"
  register: chezmoi_key_stat

- name: Fetch chezmoi age key from 1Password
  ansible.builtin.copy:
    content: "{{ lookup('community.general.onepassword_doc', dotfiles_onepassword_key_item) }}"
    dest: "{{ dotfiles_chezmoi_key_path }}"
    mode: '0600'
  when: not chezmoi_key_stat.stat.exists
  no_log: true

- name: Check if chezmoi is already initialized
  ansible.builtin.stat:
    path: "{{ dotfiles_source_dir }}/.git"
  register: chezmoi_git

- name: Initialize chezmoi with dotfiles repository
  ansible.builtin.command:
    cmd: chezmoi init --apply {{ dotfiles_repo }}
  when: not chezmoi_git.stat.exists
  changed_when: true
  register: chezmoi_init_result
  environment:
    # Ensure git uses ssh for submodules
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: "submodule.recurse"
    GIT_CONFIG_VALUE_0: "true"

- name: Display chezmoi init output
  ansible.builtin.debug:
    var: chezmoi_init_result.stdout_lines
  when:
    - not chezmoi_git.stat.exists
    - chezmoi_init_result is defined

- name: Apply chezmoi configuration
  ansible.builtin.command:
    cmd: chezmoi apply -v
  when: dotfiles_apply
  changed_when: true
  register: chezmoi_apply_result

- name: Display chezmoi apply output
  ansible.builtin.debug:
    var: chezmoi_apply_result.stdout_lines
  when:
    - dotfiles_apply
    - chezmoi_apply_result is defined
