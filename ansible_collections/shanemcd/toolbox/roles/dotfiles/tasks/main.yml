---
- name: Check if chezmoi is already initialized
  ansible.builtin.stat:
    path: "{{ dotfiles_source_dir }}/.git"
  register: chezmoi_git

- name: Initialize chezmoi with dotfiles repository
  ansible.builtin.command:
    cmd: chezmoi init --apply {{ dotfiles_repo }}
  when: not chezmoi_git.stat.exists
  changed_when: true
  register: chezmoi_init_result

- name: Display chezmoi init output
  ansible.builtin.debug:
    var: chezmoi_init_result.stdout_lines
  when:
    - not chezmoi_git.stat.exists
    - chezmoi_init_result is defined

- name: Check if setup-secrets.sh exists
  ansible.builtin.stat:
    path: "{{ dotfiles_source_dir }}/setup-secrets.sh"
  register: setup_secrets_script
  when: dotfiles_setup_secrets

- name: Run setup-secrets.sh to decrypt secrets
  ansible.builtin.command:
    cmd: "{{ dotfiles_source_dir }}/setup-secrets.sh"
  when:
    - dotfiles_setup_secrets
    - setup_secrets_script.stat.exists
  changed_when: true
  register: setup_secrets_result
  failed_when: false

- name: Display setup-secrets.sh output
  ansible.builtin.debug:
    var: setup_secrets_result.stdout_lines
  when:
    - dotfiles_setup_secrets
    - setup_secrets_script.stat.exists
    - setup_secrets_result is defined

- name: Apply chezmoi configuration
  ansible.builtin.command:
    cmd: chezmoi apply -v
  when: dotfiles_apply
  changed_when: true
  register: chezmoi_apply_result

- name: Display chezmoi apply output
  ansible.builtin.debug:
    var: chezmoi_apply_result.stdout_lines
  when:
    - dotfiles_apply
    - chezmoi_apply_result is defined
