---
- name: Validate password configuration
  ansible.builtin.assert:
    that:
      - bootc_iso_user_password != '' or bootc_iso_user_password_hash != ''
    fail_msg: "Either bootc_iso_user_password or bootc_iso_user_password_hash must be provided"

- name: Set password hash from pre-hashed value
  ansible.builtin.set_fact:
    _bootc_iso_password_hash: "{{ bootc_iso_user_password_hash }}"
  when: bootc_iso_user_password_hash != ''

- name: Generate password hash from plain text
  ansible.builtin.set_fact:
    _bootc_iso_password_hash: "{{ bootc_iso_user_password | password_hash('sha512') }}"
  when: bootc_iso_user_password_hash == '' and bootc_iso_user_password != ''

- name: Construct ISO path
  ansible.builtin.set_fact:
    bootc_iso_output_path: "{{ bootc_iso_build_context }}/bootiso/{{ bootc_iso_output_filename }}"
    bootc_iso_config_path: "{{ bootc_iso_build_context }}/config.toml"

- name: Create build context directory
  ansible.builtin.file:
    path: "{{ bootc_iso_build_context }}"
    state: directory
    mode: '0755'

- name: Check if ISO already exists
  ansible.builtin.stat:
    path: "{{ bootc_iso_output_path }}"
  register: bootc_iso_stat

- name: Skip build if ISO already exists
  ansible.builtin.debug:
    msg: "ISO already exists at {{ bootc_iso_output_path }}. Use bootc_iso_force=yes to rebuild."
  when: bootc_iso_stat.stat.exists and not (bootc_iso_force | bool)

- name: Remove existing ISO if force flag is set
  ansible.builtin.file:
    path: "{{ bootc_iso_output_path }}"
    state: absent
  when: bootc_iso_force | bool and bootc_iso_stat.stat.exists
  become: true

- name: Render bootc-image-builder config
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ bootc_iso_config_path }}"
    mode: '0600'
  when: not bootc_iso_stat.stat.exists or bootc_iso_force | bool

- name: Pull container image
  containers.podman.podman_image:
    name: "{{ bootc_iso_image }}:{{ bootc_iso_tag }}"
    state: present
  become: true
  when: not bootc_iso_stat.stat.exists or bootc_iso_force | bool

- name: Run bootc-image-builder
  containers.podman.podman_container:
    name: bootc-image-builder
    image: "{{ bootc_iso_builder_image }}"
    state: started
    recreate: true
    rm: true
    detach: false
    privileged: true
    pull: newer
    security_opt:
      - label=type:unconfined_t
    volumes:
      - "{{ bootc_iso_config_path }}:/config.toml:ro"
      - "{{ bootc_iso_build_context }}:/output"
      - /var/lib/containers/storage:/var/lib/containers/storage
    command:
      - --type
      - anaconda-iso
      - --rootfs
      - "{{ bootc_iso_rootfs }}"
      - "{{ bootc_iso_image }}:{{ bootc_iso_tag }}"
  become: true
  when: not bootc_iso_stat.stat.exists or bootc_iso_force | bool

- name: Check if generated ISO exists
  ansible.builtin.stat:
    path: "{{ bootc_iso_output_path }}"
  register: final_iso_stat

- name: Fix ownership of generated ISO
  ansible.builtin.file:
    path: "{{ bootc_iso_output_path }}"
    owner: "{{ ansible_facts['user_id'] }}"
    group: "{{ ansible_facts['user_id'] }}"
  become: true
  when: final_iso_stat.stat.exists

- name: Display ISO location
  ansible.builtin.debug:
    msg: "ISO created at: {{ bootc_iso_output_path }}"
  when: final_iso_stat.stat.exists
